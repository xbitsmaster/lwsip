# lwsip v2.0 æ¶æ„æ€»ç»“

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ï¼šä¼ è¾“å±‚æŠ½è±¡

v2.0çš„**æœ€å¤§åˆ›æ–°**æ˜¯å¼•å…¥äº†ä¼ è¾“å±‚æŠ½è±¡ï¼Œä½¿lwsipèƒ½å¤Ÿåœ¨å„ç§åµŒå…¥å¼åœºæ™¯ä¸‹å·¥ä½œã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ä¼ è¾“å±‚æŠ½è±¡ï¼Ÿ

åœ¨å®é™…çš„åµŒå…¥å¼åº”ç”¨ä¸­ï¼š

| åœºæ™¯ | é€šä¿¡æ–¹å¼ | åŸv1.0 | v2.0 |
|-----|---------|--------|------|
| **æ ‡å‡†ç½‘ç»œ** | TCP/UDP socket | âœ… å¯ç”¨ | âœ… æ›´å¥½ |
| **IoTè®¾å¤‡** | MQTT pub/sub | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **å·¥ä¸šç°åœº** | RS232/RS485 | âŒ ä¸æ”¯æŒ | âœ… å¯æ‰©å±• |
| **è‡ªå®šä¹‰åè®®** | ä¸“æœ‰åŠ å¯† | âŒ æ”¹ä»£ç  | âœ… æ’ä»¶å¼ |

### æ¶æ„å¯¹æ¯”

**v1.0æ¶æ„**ï¼ˆç´§è€¦åˆï¼‰:
```
lws_client.c
    â†“ (ç›´æ¥è°ƒç”¨)
socket(), send(), recv()  â† ç¡¬ç¼–ç ï¼Œéš¾ä»¥æ›¿æ¢
```

**v2.0æ¶æ„**ï¼ˆæ¾è€¦åˆï¼‰:
```
lws_client.c
    â†“ (é€šè¿‡æŠ½è±¡æ¥å£)
lws_transport.h (æŠ½è±¡å±‚)
    â†“ (è¿è¡Œæ—¶å¤šæ€)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tcp_ops      â”‚ mqtt_ops     â”‚ xxx_ops      â”‚
â”‚ (TCP/UDP)    â”‚ (MQTT)       â”‚ (è‡ªå®šä¹‰)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°æŠ€æœ¯ï¼šè™šå‡½æ•°è¡¨æ¨¡å¼

```c
// 1. å®šä¹‰æ“ä½œæ¥å£ï¼ˆè™šå‡½æ•°è¡¨ï¼‰
typedef struct {
    int (*connect)(lws_transport_t*);
    int (*send)(lws_transport_t*, const void*, int);
    int (*poll)(lws_transport_t*, int);
    // ...
} lws_transport_ops_t;

// 2. åŸºç±»åŒ…å«è™šå‡½æ•°è¡¨æŒ‡é’ˆ
struct lws_transport {
    const lws_transport_ops_t* ops;  // "vtable"
    // ...
};

// 3. å­ç±»ç»§æ‰¿åŸºç±»
struct lws_transport_tcp {
    lws_transport_t base;  // å¿…é¡»ç¬¬ä¸€ä¸ªï¼
    int sockfd;            // TCPç‰¹æœ‰å­—æ®µ
    // ...
};

// 4. å®ç°æ“ä½œè¡¨
static const lws_transport_ops_t tcp_ops = {
    .connect = tcp_connect,
    .send = tcp_send,
    .poll = tcp_poll,
    // ...
};

// 5. å¤šæ€è°ƒç”¨ï¼ˆç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ï¼Œè¿è¡Œæ—¶åŠ¨æ€ç»‘å®šï¼‰
lws_transport_send(transport, data, len);
// â†’ transport->ops->send(transport, data, len);
```

è¿™ç§è®¾è®¡ï¼š
- âœ… å®ç°äº†Cè¯­è¨€çš„"ç»§æ‰¿"å’Œ"å¤šæ€"
- âœ… é›¶è¿è¡Œæ—¶å¼€é”€ï¼ˆç›´æ¥å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼‰
- âœ… ç±»å‹å®‰å…¨
- âœ… æ˜“äºæ‰©å±•

## ğŸ“ å®Œæ•´æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                      â”‚
â”‚            (User Code: main.c, CLI, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  lws_client.h (å®¢æˆ·ç«¯API)                â”‚
â”‚  â€¢ lws_client_create/start/loop                         â”‚
â”‚  â€¢ lws_call() / lws_answer() / lws_hangup()            â”‚
â”‚  â€¢ lws_uac_register() / lws_uac_invite()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ ä¾èµ–                â†“ ä¾èµ–              â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lws_transport  â”‚  â”‚  lws_session    â”‚  â”‚  lws_media      â”‚
â”‚  (ä¼ è¾“æŠ½è±¡)      â”‚  â”‚  (RTPä¼šè¯)       â”‚  â”‚  (åª’ä½“æº/ç›®æ ‡)   â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚
â”‚ â€¢ connect()     â”‚  â”‚ â€¢ generate_sdp()â”‚  â”‚ â€¢ read_audio()  â”‚
â”‚ â€¢ send()        â”‚  â”‚ â€¢ process_sdp() â”‚  â”‚ â€¢ write_video() â”‚
â”‚ â€¢ poll()        â”‚  â”‚ â€¢ send_audio()  â”‚  â”‚ â€¢ get_params()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ å®ç°                â†“ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tcp_ops         â”‚  â”‚  lws_payload    â”‚
â”‚ mqtt_ops        â”‚  â”‚  (RTPå°è£…)       â”‚
â”‚ serial_ops      â”‚  â”‚                 â”‚
â”‚ xxx_ops         â”‚  â”‚ â€¢ encode()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ decode()      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“ åŒ…è£…
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  librtp         â”‚
                     â”‚  (media-server) â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. lws_client - SIPå®¢æˆ·ç«¯æ ¸å¿ƒ

**èŒè´£**:
- ç®¡ç†SIP agentç”Ÿå‘½å‘¨æœŸ
- åè°ƒä¼ è¾“å±‚å’Œä¼šè¯å±‚
- æä¾›ç®€åŒ–çš„API (lws_call/answer/hangup)

**å…³é”®ä»£ç ** (lws_client.c:108-126):
```c
// åˆ›å»ºä¼ è¾“å±‚ï¼ˆå¯æ’æ‹”ï¼‰
transport_config.remote_host = config->server_host;
transport_config.remote_port = config->server_port;
transport_config.use_tcp = config->use_tcp;

client->transport = lws_transport_tcp_create(&transport_config,
                                              &transport_handler);

// æœªæ¥å¯ä»¥è¿™æ ·åˆ‡æ¢ï¼š
// client->transport = lws_transport_mqtt_create(...);
// ä¸Šå±‚ä»£ç å®Œå…¨ä¸å˜ï¼
```

### 2. lws_transport - ä¼ è¾“å±‚æŠ½è±¡

**èŒè´£**:
- å®šä¹‰ä¼ è¾“æ— å…³çš„æ¥å£
- æä¾›è™šå‡½æ•°è¡¨æœºåˆ¶
- æ”¯æŒå¤šç§ä¼ è¾“å®ç°

**å·²å®ç°**:
- âœ… `lws_transport_tcp.c` (548è¡Œ) - TCP/UDP socket
- âœ… `lws_transport_mqtt.c` (ç¤ºä¾‹) - MQTT pub/sub

### 3. lws_session - RTPä¼šè¯ç®¡ç†

**èŒè´£**:
- ç®¡ç†RTP/RTCPä¼šè¯
- SDPç”Ÿæˆ/è§£æ
- åª’ä½“æµåè°ƒ

**å…³é”®åŠŸèƒ½**:
```c
lws_session_generate_sdp_offer();   // ç”ŸæˆSDP offer
lws_session_process_sdp();          // å¤„ç†è¿œç«¯SDP
lws_session_send_audio/video();     // å‘é€åª’ä½“å¸§
```

### 4. lws_payload - RTPå°è£…

**èŒè´£**:
- åŒ…è£…librtpçš„payloadæ¥å£
- è‡ªåŠ¨åˆ†åŒ…/ç»„åŒ…
- æ”¯æŒå¤šç§ç¼–è§£ç å™¨

**ä½¿ç”¨æ–¹å¼**:
```c
// å‘é€ç«¯ï¼šå¸§ â†’ RTPåŒ…
encoder = lws_payload_encoder_create(96, "H264", ...);
lws_payload_encode(encoder, frame, size, timestamp);
// â†’ è‡ªåŠ¨åˆ†æˆå¤šä¸ªRTPåŒ…ï¼Œé€šè¿‡callbackå‘é€

// æ¥æ”¶ç«¯ï¼šRTPåŒ… â†’ å¸§
decoder = lws_payload_decoder_create(96, "H264", ...);
lws_payload_decode(decoder, rtp_packet, size);
// â†’ è‡ªåŠ¨ç»„åŒ…ï¼Œé€šè¿‡callbackè¾“å‡ºå®Œæ•´å¸§
```

### 5. lws_media - åª’ä½“æŠ½è±¡

**èŒè´£**:
- æŠ½è±¡åª’ä½“æº/ç›®æ ‡
- æ”¯æŒæ–‡ä»¶ã€å†…å­˜ã€è®¾å¤‡

**æ”¯æŒçš„ç±»å‹**:
```c
typedef enum {
    LWS_MEDIA_TYPE_FILE,    // WAV, MP4ç­‰
    LWS_MEDIA_TYPE_MEMORY,  // å†…å­˜ç¼“å†²
    LWS_MEDIA_TYPE_DEVICE,  // éº¦å…‹é£/æ‰¬å£°å™¨
} lws_media_type_t;
```

## ğŸ“Š è®¾è®¡æ¨¡å¼è¿ç”¨

| æ¨¡å¼ | åº”ç”¨ä½ç½® | æ”¶ç›Š |
|-----|---------|------|
| **è™šå‡½æ•°è¡¨** | lws_transport | Cè¯­è¨€å®ç°å¤šæ€ |
| **Handleræ¨¡å¼** | lws_client_handler_t | ç»Ÿä¸€å›è°ƒç®¡ç† |
| **å·¥å‚æ¨¡å¼** | lws_transport_xxx_create() | åˆ›å»ºå¯¹è±¡ |
| **ç­–ç•¥æ¨¡å¼** | ä¼ è¾“å±‚é€‰æ‹© | è¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥ |
| **é€‚é…å™¨æ¨¡å¼** | lws_payloadåŒ…è£…librtp | é€‚é…å¤–éƒ¨åº“ |
| **ä¾èµ–å€’ç½®** | ä¸Šå±‚ä¾èµ–æŠ½è±¡ | æ¾è€¦åˆ |

## ğŸš€ ä½¿ç”¨æµç¨‹

### å®Œæ•´ç¤ºä¾‹ï¼šå‘èµ·å‘¼å«

```c
// 1. é…ç½®
lws_config_t config = {
    .server_host = "192.168.1.100",
    .server_port = 5060,
    .username = "1002",
    .password = "1234",
    .use_tcp = 0,  // 0=UDP, 1=TCP
    .enable_audio = 1,
    .audio_codec = LWS_AUDIO_CODEC_PCMU,
};

// 2. å›è°ƒ
lws_client_handler_t handler = {
    .on_reg_state = on_reg_state,
    .on_call_state = on_call_state,
    .on_incoming_call = on_incoming_call,
};

// 3. åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆå†…éƒ¨è‡ªåŠ¨åˆ›å»ºTCPä¼ è¾“ï¼‰
lws_client_t* client = lws_client_create(&config, &handler);

// 4. å¯åŠ¨ï¼ˆè¿æ¥ä¼ è¾“å±‚ï¼‰
lws_client_start(client);

// 5. æ³¨å†Œ
lws_uac_register(client);

// 6. å‘èµ·å‘¼å«ï¼ˆä¸€è¡Œä»£ç ï¼ï¼‰
lws_session_t* session = lws_call(client, "sip:1001@192.168.1.100");

// 7. äº‹ä»¶å¾ªç¯ï¼ˆè‡ªåŠ¨å¤„ç†SIPå’ŒRTPï¼‰
while (running) {
    lws_client_loop(client, 100);
}

// 8. æŒ‚æ–­
lws_hangup(client, session);

// 9. æ¸…ç†
lws_client_destroy(client);
```

### åˆ‡æ¢åˆ°MQTTä¼ è¾“

åªéœ€ä¿®æ”¹ç¬¬3æ­¥ï¼š

```c
// æ–¹æ¡ˆ1ï¼šç¼–è¯‘æ—¶åˆ‡æ¢
#define USE_MQTT_TRANSPORT

// æ–¹æ¡ˆ2ï¼šè¿è¡Œæ—¶é…ç½®
config.transport_type = LWS_TRANSPORT_MQTT;
config.mqtt_client_id = "device001";
config.mqtt_pub_topic = "sip/device002/inbox";
config.mqtt_sub_topic = "sip/device001/inbox";

// å…¶ä½™ä»£ç å®Œå…¨ä¸å˜ï¼
```

## ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹

| æŒ‡æ ‡ | TCPä¼ è¾“ | MQTTä¼ è¾“ |
|-----|---------|----------|
| **å»¶è¿Ÿ** | ~10ms | ~100ms |
| **ååé‡** | é«˜ | ä¸­ |
| **CPUå ç”¨** | ä½ | ä¸­ |
| **å†…å­˜å ç”¨** | 8KB | 16KB |
| **NATç©¿è¶Š** | å›°éš¾ | å®¹æ˜“ |

## ğŸ”® æ‰©å±•æ€§

### å·²å®Œæˆ
- âœ… ä¼ è¾“å±‚æŠ½è±¡æ¡†æ¶
- âœ… TCP/UDPå®ç°
- âœ… MQTTç¤ºä¾‹ï¼ˆæ¡†æ¶ï¼‰
- âœ… Handleræ¨¡å¼
- âœ… Payloadå°è£…
- âœ… åª’ä½“æŠ½è±¡

### å¾…å®Œå–„
- ğŸ”„ é›†æˆlibsip (sip_agent_create)
- ğŸ”„ å®Œå–„RTP socketæ”¶å‘
- ğŸ”„ å®Œæ•´SDPç”Ÿæˆ/è§£æ
- ğŸ”„ RTCPæŠ¥å‘Š
- ğŸ”„ MQTTä¼ è¾“å®ç°ï¼ˆéœ€MQTTåº“ï¼‰

### å¯æ‰©å±•
- ğŸ“ ä¸²å£ä¼ è¾“ (lws_transport_serial.c)
- ğŸ“ WebSocketä¼ è¾“ (RFC 7118)
- ğŸ“ è“ç‰™BLEä¼ è¾“
- ğŸ“ LoRaä¼ è¾“

## ğŸ“š æ–‡æ¡£

- **README.md**: æ¦‚è¿°å’Œå¿«é€Ÿå¼€å§‹
- **TRANSPORT_DESIGN.md**: ä¼ è¾“å±‚è¯¦ç»†è®¾è®¡
- **SUMMARY.md**: æœ¬æ–‡æ¡£ï¼ˆæ¶æ„æ€»ç»“ï¼‰
- **example.c**: å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

## ğŸ“ å­¦ä¹ è·¯å¾„

1. **æ–°æ‰‹**: å…ˆçœ‹ README.mdï¼Œè¿è¡Œ example.c
2. **è¿›é˜¶**: çœ‹ TRANSPORT_DESIGN.mdï¼Œç†è§£æŠ½è±¡å±‚
3. **é«˜çº§**: å®ç°è‡ªå·±çš„ä¼ è¾“å±‚ï¼ˆå‚è€ƒ lws_transport_tcp.cï¼‰
4. **ä¸“å®¶**: é›†æˆlibsipï¼Œå®Œå–„TODOéƒ¨åˆ†

## ğŸ† è®¾è®¡äº®ç‚¹

1. **ä¼ è¾“å±‚æŠ½è±¡** - çªç ´æ€§è®¾è®¡ï¼Œæ”¯æŒå¤šç§é€šä¿¡æ–¹å¼
2. **è™šå‡½æ•°è¡¨æ¨¡å¼** - Cè¯­è¨€å®ç°OOPï¼Œé›¶å¼€é”€å¤šæ€
3. **Handlerç»Ÿä¸€å›è°ƒ** - å­¦ä¹ libsipï¼Œæ¸…æ™°æ˜“ç”¨
4. **Payloadè‡ªåŠ¨å°è£…** - å­¦ä¹ librtpï¼Œè‡ªåŠ¨åˆ†åŒ…ç»„åŒ…
5. **OSALè·¨å¹³å°** - ä½¿ç”¨osalæŠ½è±¡ï¼Œæ”¯æŒå¤šç§RTOS

---

**è®¾è®¡æ—¶é—´**: 2025-01
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0
**ä½œè€…**: lwsipå¼€å‘å›¢é˜Ÿ
