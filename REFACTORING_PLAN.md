# Lwsip ä»£ç é‡æ„è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°
**ç›®æ ‡**ï¼šå°† lwsip ä»å•ä½“æ¶æ„é‡æ„ä¸ºæ¨¡å—åŒ–ã€åˆ†å±‚æ¶æ„
**é¢„è®¡æ—¶é—´**ï¼š8-10å‘¨
**å½“å‰çŠ¶æ€**ï¼šPhase 1 è¿›è¡Œä¸­

## é‡æ„åŸåˆ™
1. **é€»è¾‘åˆ†å±‚**ï¼šCore â†’ SIP â†’ Media â†’ RTP
2. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹
3. **æ¥å£ç®€å•**ï¼šæœ€å°åŒ–ã€æ¸…æ™°çš„å…¬å…±API
4. **ä½è€¦åˆ**ï¼šæ¨¡å—ä¹‹é—´ç‹¬ç«‹
5. **æ˜“ç»´æŠ¤**ï¼šæ¸…æ™°çš„ç»“æ„ä¾¿äºæœªæ¥å¼€å‘

## Phase 1: åŸºç¡€è®¾æ–½å±‚ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰âœ… å·²å®Œæˆ

### 1.1 æ—¥å¿—æŠ½è±¡å±‚ âœ… å·²å®Œæˆ
**åˆ›å»ºçš„æ–‡ä»¶**ï¼š
- `include/lws_log.h` - æ—¥å¿—APIå®šä¹‰
- `src/lws_log.c` - æ—¥å¿—å®ç°

**åŠŸèƒ½**ï¼š
- 5ä¸ªæ—¥å¿—çº§åˆ«ï¼ˆERROR, WARN, INFO, DEBUG, TRACEï¼‰
- çº¿ç¨‹å®‰å…¨çš„æ—¥å¿—è¾“å‡ºï¼ˆpthread_mutexä¿æŠ¤ï¼‰
- å¸¦æ—¶é—´æˆ³å’Œé¢œè‰²çš„æ ¼å¼åŒ–è¾“å‡ºï¼ˆANSIè½¬ä¹‰ç ï¼‰
- å¯è‡ªå®šä¹‰çš„è¾“å‡ºå›è°ƒ
- ä¾¿æ·çš„æ—¥å¿—å®ï¼ˆLOG_ERROR, LOG_INFOç­‰ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šåœ¨ç°æœ‰ä»£ç ä¸­é€æ­¥æ›¿æ¢ printf/fprintf ä¸ºæ—¥å¿—å®ï¼ˆå°†åœ¨åç»­Phaseä¸­è¿›è¡Œï¼‰

### 1.2 Sessionç®¡ç†å™¨ âœ… å·²å®Œæˆ
**åˆ›å»ºçš„æ–‡ä»¶**ï¼š
- `include/session_manager.h` - Sessionç®¡ç†å™¨API
- `src/session_manager.c` - Sessionç®¡ç†å™¨å®ç°

**åŠŸèƒ½**ï¼š
- å°è£…sessionå­˜å‚¨å’Œç”Ÿå‘½å‘¨æœŸ
- æ•°ç»„å­˜å‚¨ï¼ˆO(n)æŸ¥æ‰¾ï¼Œæœªæ¥å¯ä¼˜åŒ–ä¸ºå“ˆå¸Œè¡¨ï¼‰
- çº¿ç¨‹å®‰å…¨çš„CRUDæ“ä½œï¼ˆpthread_mutexä¿æŠ¤ï¼‰
- å¤šç§æŸ¥æ‰¾æ–¹å¼ï¼šby ID, by peer URI, by dialog
- è¿­ä»£å™¨æ¨¡å¼æ”¯æŒï¼ˆforeachï¼‰
- è‡ªåŠ¨èµ„æºç®¡ç†

### 1.3 çº¿ç¨‹æŠ½è±¡ âœ… å·²å®Œæˆ
**åˆ›å»ºçš„æ–‡ä»¶**ï¼š
- `include/lws_thread.h` - çº¿ç¨‹æŠ½è±¡API
- `src/lws_thread.c` - çº¿ç¨‹æŠ½è±¡å®ç°

**åŠŸèƒ½**ï¼š
- ç»Ÿä¸€çš„çº¿ç¨‹åˆ›å»º/é”€æ¯æ¥å£
- çº¿ç¨‹å‘½åï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- ä¼˜é›…çš„å…³é—­æœºåˆ¶ï¼ˆshould_stopæ ‡å¿—ï¼‰
- å¯ä¸­æ–­çš„sleepå‡½æ•°
- çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰æ”¯æŒlws_thread_current()
- æ”¯æŒdetachedå’Œjoinableæ¨¡å¼

---

## Phase 2: æ‹†åˆ† lws_client.cï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰â³ å¾…å¼€å§‹

### å½“å‰é—®é¢˜
`lws_client.c` è¿‡å¤§ï¼ˆ623è¡Œï¼‰ï¼ŒèŒè´£ä¸æ¸…ï¼š
- å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
- SIP UACæ“ä½œï¼ˆæ³¨å†Œã€å‘¼å«ï¼‰
- SIP UASæ“ä½œï¼ˆå¤„ç†incomingè¯·æ±‚ï¼‰
- ç½‘ç»œçº¿ç¨‹ç®¡ç†
- å®šæ—¶å™¨ç®¡ç†

### 2.1 æå– SIP UAC ç®¡ç†å™¨
**åˆ›å»º**ï¼š
- `include/sip_uac_manager.h`
- `src/sip_uac_manager.c`

**è¿ç§»**ï¼š
- `do_register()` å‡½æ•°
- `sip_uac_onregister()` å›è°ƒ
- `lws_register()` / `lws_unregister()`

### 2.2 æå– SIP UAS ç®¡ç†å™¨
**åˆ›å»º**ï¼š
- `include/sip_uas_manager.h`
- `src/sip_uas_manager.c`

**è¿ç§»**ï¼š
- 14ä¸ªé»˜è®¤å¤„ç†å™¨ï¼ˆlines 39-101ï¼‰
- `sip_uas_oninvite()`, `sip_uas_onbye()`, `sip_uas_onack()`

### 2.3 æå–ç½‘ç»œç®¡ç†å™¨
**åˆ›å»º**ï¼š
- `include/network_manager.h`
- `src/network_manager.c`

**è¿ç§»**ï¼š
- `network_thread_func()`
- `timer_thread_func()`

### 2.4 ç®€åŒ– lws_client.c
**ç›®æ ‡**ï¼šä» 623è¡Œ â†’ ~150è¡Œ

**ä¿ç•™åŠŸèƒ½**ï¼š
- `lws_client_create()` - ç»„è£…æ‰€æœ‰ç®¡ç†å™¨
- `lws_client_destroy()` - æ¸…ç†
- `lws_client_start()` / `stop()` - å¯åŠ¨/åœæ­¢
- å§”æ‰˜æ“ä½œç»™å„ä¸ªç®¡ç†å™¨

---

## Phase 3: æ”¹è¿› Media å±‚ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰â³ å¾…å¼€å§‹

### 3.1 æå– SDP å¤„ç†å™¨
**åˆ›å»º**ï¼š
- `include/sdp_handler.h`
- `src/sdp_handler.c`

**åŠŸèƒ½**ï¼šåˆ†ç¦»SDPç”Ÿæˆ/è§£æä¸åª’ä½“æ§åˆ¶é€»è¾‘

### 3.2 åˆ›å»º Media Pipeline
**åˆ›å»º**ï¼š
- `include/media_pipeline.h`
- `src/media_pipeline.c`
- `include/media_source.h`
- `include/media_sink.h`

**ç›®æ ‡**ï¼š
- æ¶ˆé™¤å›è°ƒåœ°ç‹±
- æ¸…æ™°çš„æ•°æ®æµ
- æ˜“äºæ·»åŠ è¿‡æ»¤å™¨/å¤„ç†å™¨

### 3.3 é‡æ„ media_session.c
**ç›®æ ‡**ï¼š
- ç§»é™¤å†…åµŒå›è°ƒ
- ä½¿ç”¨ pipeline æ¨¡å¼
- ä» 458è¡Œ â†’ ~250è¡Œ

---

## Phase 4: æ”¹è¿› RTP å±‚ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰â³ å¾…å¼€å§‹

### 4.1 åˆå¹¶ RTP æ¨¡å—
**å½“å‰é—®é¢˜**ï¼šRTPé€»è¾‘åˆ†æ•£åœ¨3ä¸ªæ–‡ä»¶ä¸­

**æ–°ç»“æ„**ï¼š
```
rtp/
â”œâ”€â”€ rtp_stream.c     (æµç®¡ç†)
â”œâ”€â”€ rtp_codec.c      (ç¼–è§£ç )
â””â”€â”€ rtp_transport.c  (ç½‘ç»œI/O)
```

### 4.2 ç®€åŒ– RTP å›è°ƒé“¾
**ç›®æ ‡**ï¼š
- ä» 4å±‚å›è°ƒ â†’ ç›´æ¥è°ƒç”¨
- æ›´æ¸…æ™°çš„æ•°æ®æµ

---

## Phase 5: API æ”¹è¿›ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰â³ å¾…å¼€å§‹

### 5.1 æ”¹è¿›å…¬å…± API
**æ·»åŠ **ï¼š
- SessionæŸ¥è¯¢API
- SessionçŠ¶æ€æŸ¥è¯¢
- æ›´å¤šæ§åˆ¶æ¥å£

### 5.2 éšè—å†…éƒ¨ç±»å‹
**åˆ›å»º**ï¼š
- `src/private/client_private.h`
- `src/private/session_private.h`

**ç›®æ ‡**ï¼šå‡å°‘ `lws_internal.h` æš´éœ²çš„å†…å®¹

---

## Phase 6: æµ‹è¯•åŸºç¡€è®¾æ–½ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰â³ å¾…å¼€å§‹

### 6.1 å•å…ƒæµ‹è¯•æ¡†æ¶
**åˆ›å»º**ï¼š
```
tests/
â”œâ”€â”€ test_session_manager.c
â”œâ”€â”€ test_sdp_handler.c
â”œâ”€â”€ test_media_pipeline.c
â””â”€â”€ test_rtp_stream.c
```

### 6.2 Mockå¯¹è±¡
**ä¸ºä»¥ä¸‹åˆ›å»ºMock**ï¼š
- SIP agent
- ç½‘ç»œI/O
- æ–‡ä»¶I/O

---

## æœ€ç»ˆç›®æ ‡ç»“æ„

```
lwsip/
â”œâ”€â”€ include/              # å…¬å…±API
â”‚   â”œâ”€â”€ lws_client.h
â”‚   â”œâ”€â”€ lws_types.h
â”‚   â””â”€â”€ lws_log.h     âœ… å·²åˆ›å»º
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ private/         # ç§æœ‰å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ core/            # æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ lws_client.c   (150è¡Œï¼Œä»623è¡Œå‡å°‘)
â”‚   â”‚   â”œâ”€â”€ session_manager.c
â”‚   â”‚   â””â”€â”€ network_manager.c
â”‚   â”œâ”€â”€ sip/             # SIPå±‚
â”‚   â”‚   â”œâ”€â”€ sip_uac_manager.c
â”‚   â”‚   â”œâ”€â”€ sip_uas_manager.c
â”‚   â”‚   â”œâ”€â”€ sip_transport.c
â”‚   â”‚   â””â”€â”€ sip-timer.c
â”‚   â”œâ”€â”€ media/           # Mediaå±‚
â”‚   â”‚   â”œâ”€â”€ media_session.c   (250è¡Œï¼Œä»458è¡Œå‡å°‘)
â”‚   â”‚   â”œâ”€â”€ media_pipeline.c
â”‚   â”‚   â”œâ”€â”€ sdp_handler.c
â”‚   â”‚   â””â”€â”€ media_file_io.c
â”‚   â”œâ”€â”€ rtp/             # RTPå±‚
â”‚   â”‚   â”œâ”€â”€ rtp_stream.c
â”‚   â”‚   â”œâ”€â”€ rtp_codec.c
â”‚   â”‚   â””â”€â”€ rtp_transport.c
â”‚   â”œâ”€â”€ call/            # Call handling
â”‚   â”‚   â””â”€â”€ lws_call.c
â”‚   â”œâ”€â”€ infra/           # Infrastructure
â”‚   â”‚   â”œâ”€â”€ lws_log.c      âœ… å·²åˆ›å»º
â”‚   â”‚   â””â”€â”€ lws_thread.c
â”‚   â””â”€â”€ main.c
â””â”€â”€ tests/               # æµ‹è¯•
```

---

## é‡Œç¨‹ç¢‘å’Œæ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|------|----------|------|
| Phase 1.1 | æ—¥å¿—æŠ½è±¡å±‚ | 1å¤© | âœ… å®Œæˆ |
| Phase 1.2 | Sessionç®¡ç†å™¨ | 2å¤© | âœ… å®Œæˆ |
| Phase 1.3 | çº¿ç¨‹æŠ½è±¡ | 2å¤© | âœ… å®Œæˆ |
| Phase 2.1 | SIP UACç®¡ç†å™¨ | 3å¤© | â³ å¾…å¼€å§‹ |
| Phase 2.2 | SIP UASç®¡ç†å™¨ | 3å¤© | â³ å¾…å¼€å§‹ |
| Phase 2.3 | ç½‘ç»œç®¡ç†å™¨ | 2å¤© | â³ å¾…å¼€å§‹ |
| Phase 2.4 | ç®€åŒ–lws_client.c | 3å¤© | â³ å¾…å¼€å§‹ |
| Phase 3 | Mediaå±‚ | 2å‘¨ | â³ å¾…å¼€å§‹ |
| Phase 4 | RTPå±‚ | 2å‘¨ | â³ å¾…å¼€å§‹ |
| Phase 5 | APIæ”¹è¿› | 1å‘¨ | â³ å¾…å¼€å§‹ |
| Phase 6 | æµ‹è¯• | 2å‘¨ | â³ å¾…å¼€å§‹ |

**æ€»è®¡**ï¼š8-10å‘¨

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆPhase 1ç»§ç»­ï¼‰
1. âœ… ~~åˆ›å»ºæ—¥å¿—æŠ½è±¡å±‚~~
2. åœ¨æ‰€æœ‰æºæ–‡ä»¶ä¸­æ›¿æ¢ printf â†’ LOG_* å®
3. åˆ›å»º session_manager æ¨¡å—
4. åˆ›å»ºçº¿ç¨‹æŠ½è±¡å±‚
5. ç¼–è¯‘æµ‹è¯•

### é£é™©å’Œç¼“è§£
| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| ç ´åç°æœ‰åŠŸèƒ½ | å¢é‡é‡æ„ï¼Œæ¯æ­¥æµ‹è¯• |
| æ€§èƒ½å›é€€ | Before/AfteråŸºå‡†æµ‹è¯• |
| è¿›åº¦å»¶æœŸ | ä¼˜å…ˆçº§åˆ†é˜¶æ®µï¼Œå¯éšæ—¶åœæ­¢ |

---

## è¿›åº¦è·Ÿè¸ª

**æœ€åæ›´æ–°**ï¼š2025-11-03
**å®Œæˆç™¾åˆ†æ¯”**ï¼š15% (Phase 1 å®Œæˆ)
**å½“å‰ç„¦ç‚¹**ï¼šPhase 2 æ‹†åˆ† lws_client.c

**æœ€è¿‘å®Œæˆ**ï¼š
- âœ… Phase 1.1: åˆ›å»ºæ—¥å¿—æŠ½è±¡å±‚ï¼ˆlws_log.h/cï¼‰
- âœ… Phase 1.2: åˆ›å»ºSessionç®¡ç†å™¨ï¼ˆsession_manager.h/cï¼‰
- âœ… Phase 1.3: åˆ›å»ºçº¿ç¨‹æŠ½è±¡å±‚ï¼ˆlws_thread.h/cï¼‰
- âœ… ä¿®å¤ç¼–è¯‘é”™è¯¯å¹¶æˆåŠŸæ„å»º
- âœ… éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶æ­£å¸¸è¿è¡Œ

**æ¥ä¸‹æ¥**ï¼š
- ğŸ”„ Phase 2: å¼€å§‹æ‹†åˆ† lws_client.c
- ğŸ”„ æå– SIP UAC ç®¡ç†å™¨
- ğŸ”„ æå– SIP UAS ç®¡ç†å™¨
- ğŸ”„ æå–ç½‘ç»œç®¡ç†å™¨
